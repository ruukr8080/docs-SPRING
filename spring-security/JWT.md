Json Web Token


서벙에서는 API 호출에 대한 클라이언트 검증을 위해 요청 클라이언트에 대해 인증 절차를 거치는데
이를 위한 몇가지 방식이 있음.

## 세션&쿠키 인증 방식

- 세션 user정보를 서버에서 관리
	 세션 ID를 발급해서 사용자를 구분함.


- 쿠키는 user정보를 클라이언트에서 관리.
	 User정보를 키와 값으로 저장함.
 ![[Pasted image 20240830185734.png]]

1. User가 로그인 요청을 보냄.
2. (인증 된 User일 경우) 유일한 세션 ID를 생성하고, User의 ID 및 정보를 세션 ID에 연결시킴
3. 클라이언트가 세션 ID를 쿠키에 저장하도록 전달.
4. 클라이언트는 발급받은 세션 ID를 쿠키에 저장하고, 인증이 필요한 요청 때 마다 헤더에 쿠를 실어 보냄.
5. 서버는 쿠키에 있는 세션ID를 이용해서 User 정보를 가져와서 인증함.
6. 인증이 되면 원하는 응답을 보내줌.

	서버는 세션 ID를 저장하기 위한 세션 저장소가 필요하고, 일반적으로 Redis를 많이 사용한다.

세션 & 쿠키 인증 방식의 단점.

	서버가 세션을 저장하고 관리해야 된다는게 단점인데 이게 왜 단점이냐면.
	사용자 수 만큼 세션 발급해야 됨. 
	그럼 사용자 별로 세션 ID가 관리 되야되니까 멀티 디바이스에 대한 고려가 필요하게 됨.
	그리고 쿠키를 탈취당해서 해당 쿠키로 요청을 보내도 알 수 가 없음.

방어를 위해 http로 헤더를 암호화 하고 쿠키의 시간을 짧게 설정해줘야됨.


그래서 JWT 토큰 기반 인증 방식을 써야됨
---

## JWT
Json Web Token

Jwt는 Claim(권한) 이라는 정보를 디지털 서명을 하고,
비밀key로 조작 여부등을 판단하여 검증하는 방식임.

- 전자 서명 된 URL-safe(URL로 이용할 수 있는 문자로만 구성된)의 JSON (Base64url 인코딩을 사용한다)
- 세션 아이디 대신에 토큰을 사용함으로서 서버측 부하를 낮추고 능률적인 접근 권한 관리가 가능하다.
- 최초의 인증은 사용자 로그인을 통해서 이뤄지고 이때 토큰이 생성된다. 해당 토큰에는 사용자 PK, 권한 등이 들어간다.


![](https://blog.kakaocdn.net/dn/4Fist/btrb8UVOSWp/Yq7CHbwp6dJfC4VkTJz0A1/img.png)

jwt은 [ . ] 을 기준으로 header, payload, signature 세부분으로 구성됨.

## Header

토큰의 유형.
- 토큰의 타입과 해시 암호화 알고리즘
- alg : 서명 시 사용하는 알고리즘 (ex. ES256)
## payload

Claim (권한) 정보.

구성

	- 토큰 생성자의 정보 (클라이언트 구분 값),
	- 토큰 생성 시간
	- 만료 시간 등의 값

## Signature

헤더랑 페이로드를 합친 문자열을 서명한 **최종 서명 값.**

서명은 헤더에서 명시한 algorithm(SignatureAlgorithm.HS256)과 Base 64 URL-safef로 인코딩한 secretKey값을 이용해서 생성한다.




### 토큰 기반 인증의 장점
- 세션/쿠키 방식과 달리 토큰을 따로 저장,관리 할 필요가 없음. 로그인시에 토큰 발급해주고 요청이 올때 토큰을 받아서 검증함.
- 상태관리 같은게 필요없으니 서버 확장 유지 보수 할때 유리함.
- OAuth 2의 토큰 기반 인증방식 사용 가능. 따로 join/login을 위한 로직 구현 안해도됨. OAuth2를 이용해서 구글 로그인,카카오 로그인등 사용 가능.

### 토큰 기반 인증의 단점
- 한 번 발급된 토큰은 변경이 안됨. 예를들어 관리자 앞으로 발행 된 토큰이 있는데 관리자가 일반 회원으로 강등돼도 해당 토큰은 만료 될 때까지 관리자 권한을 갖고 있음.
- 토큰이 한 번 갈취되면 만료될 때까지 해킹 가능함.
- Payload는 공개값이라 함호화 해서 넣어야되고 JWT의 길이가 매우 길어서 인증요청이 너무 많으면 데이터 트래픽에 부하가 올 수 있음.

#### 토큰 기반 인증 단점 극복!

### ## Access Token + Refresh Token 방식

토큰이 한번 갈취당하면 만료시간까지 속수무책이고, 그렇다고 토큰 만료시간을 짧게 하자니 
만료때 마다 사용자가 재로그인을 해야됨. 
보안성 편의성 둘 다 잡는 방법이 바로 **Access Token + Refresh Token** 방식임

- 액세스 토큰의 만료시간은 30분 ~ 1시간 정도로 짧게 준다.
- 리프레시 토큰은 만료시간을 2주 정도로 넉넉히 잡아준다.
- 액세스 토큰이 만료되었는데 사용자의 요청이 오면 해당 사용자의 리프레시 토큰을 본다.
- 리프레시 토큰이 만료되지 않았다면 로그아웃 시키지 않고 액세스 토큰과 리프레시 토큰을 재발급해주고 로그인 상태를 유지한다.
- 리프레시 토큰이 만료된 경우에만 로그아웃 시킨다.

---
Ref: 
1. https://ws-pace.tistory.com/87
